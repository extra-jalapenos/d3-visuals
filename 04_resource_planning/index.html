<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Planning</title>
    <link rel="stylesheet" href="base.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
</head>
<body>
<script type="module">
    // for FULL view!
    const width = document.documentElement.clientWidth
    const height = document.documentElement.clientHeight

    const body = d3.select("body")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", `0, 0, ${width}, ${height}`)
        .attr("preserveAspectRatio", "none")

    const worklogDataRaw = await d3.tsv("../02_audit_duedates/worklogs.txt")
    const auditDataRaw = await d3.tsv("../02_audit_duedates/audits.txt")
    const stepsRaw = await d3.tsv("../01_status_burndown/steps.tsv")
    const steps = d3.index(stepsRaw.map(d => {
        return { ...d, id: Number(d.id), stageId: Number(d.stageId), Punkte: parseFloat(d.Punkte) }
    }), d => d.stepName)

    // because my data is so old i'm gonna pretend that "TODAY" is the 10th of Feb 2023
    // replace with new Date() for true today
    const today = new Date(2023, 1, 10) // actually today: const today = new Date()

    const auditDueDates = d3.index(auditDataRaw.map(d => {
            const [day, month, year] = d.dueDateAudit.split(" ")[0].split(".")
            return {
                auditId: d.auditId,
                dueDate: isNaN(year) === false ? new Date(year, month-1, day) : null
            }
        })
        .filter(d => d.dueDate !== null)
        , d => d.auditId)

    const worklogData = worklogDataRaw
        .map(d => {
            const [day, month, year] = d.doneAt.split(" ")[0].split(".")
            return {
                ...d,
                workstep: steps.get(d.workstep),
                doneAt: isNaN(year) === false ? new Date(year, month-1, day) : null
            }
        })
        .filter(d => d.doneAt !== null && d.doneAt <= today) // get rid of all steps with unknown doneAt date

    // we have the problem of seasonal work -- if we assume e.g. that audits are done 6 weeks prior to due date, we'll have a spike of "audits to do" for all 800 clients.
    // to circumvent this, we'll analyse the past, assuming that humans will human; we will render past data in a form that allows us to get an answer to the question:
    // "across all past audits of type EEG 2009, that were progressed to VB II 12 weeks out from due date, when did the progression to "audit" take place?"
    // there will be a distribution of some kind which we will then sample for the current audits to predict when the audit will take place.

</script>
</body>
</html>