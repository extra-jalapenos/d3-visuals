<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Planning</title>
    <link rel="stylesheet" href="base.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
</head>
<body>
<script type="module">
    // for FULL view!
    const width = document.documentElement.clientWidth
    const height = document.documentElement.clientHeight

    const body = d3.select("body")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", `0, 0, ${width}, ${height}`)
        .attr("preserveAspectRatio", "none")

    const worklogDataRaw = await d3.tsv("../02_audit_duedates/worklogs.txt")
    const auditDataRaw = await d3.tsv("../02_audit_duedates/audits.txt")
    const stepsRaw = await d3.tsv("../01_status_burndown/steps.tsv")
    const steps = d3.index(stepsRaw.map(d => {
        return { ...d, id: Number(d.id), stageId: Number(d.stageId), Punkte: parseFloat(d.Punkte) }
    }), d => d.stepName)

    // because my data is so old i'm gonna pretend that "TODAY" is the 10th of Feb 2023
    // replace with new Date() for true today
    const today = new Date(2023, 1, 10) // actually today: const today = new Date()

    const auditDueDates = d3.index(auditDataRaw.map(d => {
            const [day, month, year] = d.dueDateAudit.split(" ")[0].split(".")
            return {
                auditId: d.auditId,
                dueDate: (!isNan(year)) ? new Date(year, month-1, day) : null
            }
        })
            .map(d => d.dueDate !== null)
        , d => d.auditId)

    const auditFactMap = d3.index(auditFactData, d => d.auditId)

    const worklogDataFiltered = worklogDataRaw
        .map(d => {
            const [day, month, year] = d.doneAt.split(" ")[0].split(".")
            return {
                ...d,
                workstepId: steps.get(d.workstep),
                doneAt: new Date(year, month-1, day)
            }
        })
        .filter(d => d.doneAt <= today)

</script>
</body>
</html>