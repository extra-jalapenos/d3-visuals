<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Audit Duedates</title>
	<link rel="stylesheet" href="base.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
</head>
<body>
<script type="module">
	const width = document.documentElement.clientWidth
	const height = document.documentElement.clientHeight

	const svg = d3.select("body")
		.append("svg")
		.attr("width", width)
		.attr("height", height)
		.attr("viewBox", `0, 0, ${width}, ${height}`)
		.attr("preserveAspectRatio", "none")

	const margins = { top: 10, bottom: 30, left: 50, right: 20 }

	const canvas = svg
		.append("g")
		.attr("class", "canvas")
		.attr("width", width - margins.left - margins.right)
		.attr("height", height - margins.top - margins.bottom)
		.attr("transform", `translate(${margins.left}, ${margins.top})`)

	const axesGroup = svg.append("g")
		.attr("class", "axes")

	const xAxis = axesGroup.append("g")
		.attr("class", "x axis")
		.attr("transform", `translate(${margins.left}, ${height - margins.bottom})`)

	const yAxis = axesGroup.append("g")
		.attr("class", "y axis")
		.attr("transform", `translate(${margins.left}, ${margins.top})`)

	const worklogDataRaw = await d3.tsv("./worklogs.txt")
	const auditDataRaw = await d3.tsv("./audits.txt")
	const stepsRaw = await d3.tsv("../01_status_burndown/steps.tsv")
	const steps = d3.index(stepsRaw.map(d => {
		return { ...d, id: Number(d.id), stageId: Number(d.stageId), Punkte: parseFloat(d.Punkte) }
	}), d => d.stepName)
	// because my data is so old i'm gonna pretend that "TODAY" is the 10th of Feb 2024
	const today = new Date(2024, 1, 10)

	const auditFactData = auditDataRaw.map(d => {
			const [day, month, year] = d.dueDateAudit.split(" ")[0].split(".")
			return {
				auditId: d.auditId,
				progress: steps.get(d.progressLabel),
				dueDate: new Date(year, month-1, day)
			}
		})

	const auditFactMap = d3.index(auditFactData, d => d.auditId)
	// only keep awsv / vaws and specific steps
	const worklogDataFiltered = worklogDataRaw
		.filter(d => d.auditId.includes("_awsv") || d.auditId.includes("_vaws"))
		.filter(d => ["Termin", "Freigabe", "Versand"].includes(d.workstep))
		.map(d => {
			const [day, month, year] = d.doneAt.split(" ")[0].split(".")
			return {
				...d,
				workstep: steps.get(d.workstep),
				doneAt: new Date(year, month-1, day)
			}
		})

	// create a map by audit
	const auditEvaluationMap = d3.group(worklogDataFiltered, d => d.auditId)

	// for each map process the content so we get { "done": true, "daysBetweenAudit": 23, "auditDate": Date, "auditor": Name }
	for (const audit of auditEvaluationMap) {
		const [auditId, data] = audit
		const rollupMap = d3.rollup(data, D => d3.min(D.map(d => d.doneAt)), d => d.workstep.stepName)
		// due date etc. lookup:
		const auditFacts = auditFactMap.get(auditId)
		// as long as progress is above 11 done is true
		const status = auditFacts.progress
		const category = () => {
			if (!rollupMap.get("Termin")) return "To Do"
			if (!rollupMap.get("Versand")) return "Finalized"
			return "Done"
		}

		const processTime = () => {
			const start = rollupMap.get("Termin")
			// if we don't know the sendoff date we'll settle for finalization
			const end = rollupMap.get("Versand") || rollupMap.get("Freigabe") || today
			if (!start) return null
			const differenceInDays = (
				Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate())
				- Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate())
			) / (1000 * 86400)
			return differenceInDays
		}

		const differenceInDays = processTime()
		const calculateProcessTimeCategory = () => {
			if (differenceInDays === null || differenceInDays < 0) return "unknown"
			const timeBordersInWeeks = [ 1, 2, 3, 4, 5, 6, 7, 8 ]
			const numWeeks = timeBordersInWeeks.findLast(weekNum => weekNum *7 <= differenceInDays)
			return `${numWeeks} Woche${numWeeks >= 1 ? "n" : ""}`
		}
		calculateProcessTimeCategory()

		auditEvaluationMap.set(auditId, {
			progress: auditFacts.progress,
			category: category(),
			differenceInDays,
			processTimeGroup: calculateProcessTimeCategory(),
			audit: rollupMap.get("Termin"),
			dueDate: auditFacts.dueDate
		})
	}

	console.log(auditEvaluationMap)
</script>
</body>
</html>
