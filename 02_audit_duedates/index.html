<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Audit Duedates</title>
	<link rel="stylesheet" href="base.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
</head>
<body>
<script type="module">
	const width = document.documentElement.clientWidth
	const height = document.documentElement.clientHeight

	const svg = d3.select("body")
		.append("svg")
		.attr("width", width)
		.attr("height", height)
		.attr("viewBox", `0, 0, ${width}, ${height}`)
		.attr("preserveAspectRatio", "none")

	const margins = { top: 10, bottom: 30, left: 50, right: 20 }

	const canvas = svg
		.append("g")
		.attr("class", "canvas")
		.attr("width", width - margins.left - margins.right)
		.attr("height", height - margins.top - margins.bottom)
		.attr("transform", `translate(${margins.left}, ${margins.top})`)

	const axesGroup = svg.append("g")
		.attr("class", "axes")

	const xAxis = axesGroup.append("g")
		.attr("class", "x axis")
		.attr("transform", `translate(${margins.left}, ${height - margins.bottom})`)

	const yAxis = axesGroup.append("g")
		.attr("class", "y axis")
		.attr("transform", `translate(${margins.left}, ${margins.top})`)

	const worklogDataRaw = await d3.tsv("./worklogs.txt")
	const auditDataRaw = await d3.tsv("./audits.txt")
	const stepsRaw = await d3.tsv("../01_status_burndown/steps.tsv")
	const steps = d3.index(stepsRaw.map(d => {
		return { ...d, id: Number(d.id), stageId: Number(d.stageId), Punkte: parseFloat(d.Punkte) }
	}), d => d.stepName)

	const auditData = auditDataRaw.map(d => {
			const [year, month, day] = d.dueDateAudit.split(" ")[0].split(".")
			return {
				auditId: d.auditId,
				progress: steps.get(d.progressLabel),
				dueDateAudit: new Date(year, month-1, day)
			}
		})

	const auditDataMap = d3.index(auditData, d => d.auditId)
	// only keep awsv / vaws and specific steps
	const worklogDataFiltered = worklogDataRaw
		.filter(d => d.auditId.includes("_awsv") || d.auditId.includes("_vaws"))
		.filter(d => ["Termin", "Freigabe", "Versand"].includes(d.workstep))
		.map(d => {
			const [year, month, day] = d.doneAt.split(" ")[0].split(".")
			return {
				...d,
				workstep: steps.get(d.workstep),
				doneAt: new Date(year, month-1, day)
			}
		})

	// create a map by audit
	const auditMap = d3.group(worklogDataFiltered, d => d.auditId)

	// for each map process the content so we get { "done": true, "daysBetweenAudit": 23, "auditDate": Date, "auditor": Name }
	for (const auditGroup of auditMap) {
		const [auditId, data] = auditGroup
		const rollupMap = d3.rollup(data, D => d3.min(D.map(d => d.doneAt)), d => d.workstep)
		auditMap.set(auditId, rollupMap)
	}

	console.log(auditMap)
</script>
</body>
</html>
